# This file is automatically generated from cmake.toml - DO NOT EDIT
# See https://github.com/build-cpp/cmkr for more information

cmake_minimum_required(VERSION 3.15)

if(CMAKE_SOURCE_DIR STREQUAL CMAKE_BINARY_DIR)
	message(FATAL_ERROR "In-tree builds are not supported. Run CMake from a separate directory: cmake -B build")
endif()

set(CMKR_ROOT_PROJECT OFF)
if(CMAKE_CURRENT_SOURCE_DIR STREQUAL CMAKE_SOURCE_DIR)
	set(CMKR_ROOT_PROJECT ON)

	# Bootstrap cmkr and automatically regenerate CMakeLists.txt
	include(cmkr.cmake OPTIONAL RESULT_VARIABLE CMKR_INCLUDE_RESULT)
	if(CMKR_INCLUDE_RESULT)
		cmkr()
	endif()

	# Enable folder support
	set_property(GLOBAL PROPERTY USE_FOLDERS ON)

	# Create a configure-time dependency on cmake.toml to improve IDE support
	configure_file(cmake.toml cmake.toml COPYONLY)
endif()

# Options
option(CAPSTONE_BPF_SUPPORT "" OFF)
option(CAPSTONE_EVM_SUPPORT "" OFF)
option(CAPSTONE_MIPS_SUPPORT "" OFF)
option(CAPSTONE_BUILD_STATIC_RUNTIME "" ON)
option(CAPSTONE_M680X_SUPPORT "" OFF)
option(CAPSTONE_M68K_SUPPORT "" OFF)
option(CAPSTONE_MOS65XX_SUPPORT "" OFF)
option(CAPSTONE_PPC_SUPPORT "" OFF)
option(CAPSTONE_RISCV_SUPPORT "" OFF)
option(CAPSTONE_SH_SUPPORT "" OFF)
option(CAPSTONE_SPARC_SUPPORT "" OFF)
option(CAPSTONE_SYSZ_SUPPORT "" OFF)
option(CAPSTONE_TMS320C64X_SUPPORT "" OFF)
option(CAPSTONE_TRICORE_SUPPORT "" OFF)
option(CAPSTONE_WASM_SUPPORT "" OFF)
option(CAPSTONE_XCORE_SUPPORT "" OFF)

# Variables
set(CMAKE_CXX_COMPILER cl)
set(CMAKE_C_COMPILER cl)
set(VCPKG_TARGET_TRIPLET x64-windows-static)
set(CMAKE_CONFIGURATION_TYPES "Release;RelWithDebInfo")
set(LLVM_USE_CRT_RELEASE MT)
set(LLVM_USE_CRT_RELWITHDEBINFO MT)

project(Revampire
	LANGUAGES
		C
		CXX
)

if (MSVC)
	set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /MT")
	set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MT")
	# Statically compile runtime
	string(REGEX REPLACE "/MD" "/MT" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
	string(REGEX REPLACE "/MD" "/MT" CMAKE_C_FLAGS "${CMAKE_C_FLAGS}")
	string(REGEX REPLACE "/MD" "/MT" CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE}")
	string(REGEX REPLACE "/MD" "/MT" CMAKE_C_FLAGS_RELEASE "${CMAKE_C_FLAGS_RELEASE}")
	message(NOTICE "Building in MT mode")
endif(MSVC)

if(CMKR_ROOT_PROJECT AND NOT CMKR_DISABLE_VCPKG)
	include(FetchContent)
	# Fix warnings about DOWNLOAD_EXTRACT_TIMESTAMP
	if(POLICY CMP0135)
		cmake_policy(SET CMP0135 NEW)
	endif()
	message(STATUS "Fetching vcpkg (2024.03.25)...")
	FetchContent_Declare(vcpkg URL "https://github.com/microsoft/vcpkg/archive/refs/tags/2024.03.25.tar.gz")
	FetchContent_GetProperties(vcpkg)
	if(NOT vcpkg_POPULATED)
		FetchContent_Populate(vcpkg)
		if(CMAKE_HOST_SYSTEM_NAME STREQUAL Darwin AND CMAKE_OSX_ARCHITECTURES STREQUAL "")
			set(CMAKE_OSX_ARCHITECTURES ${CMAKE_HOST_SYSTEM_PROCESSOR} CACHE STRING "" FORCE)
		endif()
		include("${vcpkg_SOURCE_DIR}/scripts/buildsystems/vcpkg.cmake")
	endif()
endif()

# Packages
find_package(z3 REQUIRED)

include(FetchContent)

message(STATUS "Fetching capstone (5.0.1)...")
FetchContent_Declare(capstone SYSTEM
	GIT_REPOSITORY
		"https://github.com/capstone-engine/capstone"
	GIT_TAG
		5.0.1
)
FetchContent_MakeAvailable(capstone)

# Target: Revampire
set(Revampire_SOURCES
	"src/IDAPlugin.cpp"
	"src/main.cpp"
	"src/Ghidra/action.cc"
	"src/Ghidra/address.cc"
	"src/Ghidra/architecture.cc"
	"src/Ghidra/block.cc"
	"src/Ghidra/blockaction.cc"
	"src/Ghidra/callgraph.cc"
	"src/Ghidra/capability.cc"
	"src/Ghidra/cast.cc"
	"src/Ghidra/comment.cc"
	"src/Ghidra/comment_ghidra.cc"
	"src/Ghidra/condexe.cc"
	"src/Ghidra/context.cc"
	"src/Ghidra/coreaction.cc"
	"src/Ghidra/cover.cc"
	"src/Ghidra/cpool.cc"
	"src/Ghidra/cpool_ghidra.cc"
	"src/Ghidra/crc32.cc"
	"src/Ghidra/database.cc"
	"src/Ghidra/database_ghidra.cc"
	"src/Ghidra/double.cc"
	"src/Ghidra/dynamic.cc"
	"src/Ghidra/emulate.cc"
	"src/Ghidra/emulateutil.cc"
	"src/Ghidra/filemanage.cc"
	"src/Ghidra/float.cc"
	"src/Ghidra/flow.cc"
	"src/Ghidra/fspec.cc"
	"src/Ghidra/funcdata.cc"
	"src/Ghidra/funcdata_block.cc"
	"src/Ghidra/funcdata_op.cc"
	"src/Ghidra/funcdata_varnode.cc"
	"src/Ghidra/ghidra_arch.cc"
	"src/Ghidra/ghidra_context.cc"
	"src/Ghidra/ghidra_translate.cc"
	"src/Ghidra/globalcontext.cc"
	"src/Ghidra/grammar.cc"
	"src/Ghidra/graph.cc"
	"src/Ghidra/heritage.cc"
	"src/Ghidra/inject_ghidra.cc"
	"src/Ghidra/inject_sleigh.cc"
	"src/Ghidra/interface.cc"
	"src/Ghidra/jumptable.cc"
	"src/Ghidra/libdecomp.cc"
	"src/Ghidra/loadimage.cc"
	"src/Ghidra/loadimage_ghidra.cc"
	"src/Ghidra/loadimage_xml.cc"
	"src/Ghidra/marshal.cc"
	"src/Ghidra/memstate.cc"
	"src/Ghidra/merge.cc"
	"src/Ghidra/modelrules.cc"
	"src/Ghidra/op.cc"
	"src/Ghidra/opbehavior.cc"
	"src/Ghidra/opcodes.cc"
	"src/Ghidra/options.cc"
	"src/Ghidra/override.cc"
	"src/Ghidra/paramid.cc"
	"src/Ghidra/pcodecompile.cc"
	"src/Ghidra/pcodeinject.cc"
	"src/Ghidra/pcodeparse.cc"
	"src/Ghidra/pcoderaw.cc"
	"src/Ghidra/prefersplit.cc"
	"src/Ghidra/prettyprint.cc"
	"src/Ghidra/printc.cc"
	"src/Ghidra/printjava.cc"
	"src/Ghidra/printlanguage.cc"
	"src/Ghidra/rangeutil.cc"
	"src/Ghidra/raw_arch.cc"
	"src/Ghidra/ruleaction.cc"
	"src/Ghidra/rulecompile.cc"
	"src/Ghidra/semantics.cc"
	"src/Ghidra/signature.cc"
	"src/Ghidra/sleigh.cc"
	"src/Ghidra/sleigh_arch.cc"
	"src/Ghidra/sleighbase.cc"
	"src/Ghidra/slghpatexpress.cc"
	"src/Ghidra/slghpattern.cc"
	"src/Ghidra/slghsymbol.cc"
	"src/Ghidra/space.cc"
	"src/Ghidra/string_ghidra.cc"
	"src/Ghidra/stringmanage.cc"
	"src/Ghidra/subflow.cc"
	"src/Ghidra/transform.cc"
	"src/Ghidra/translate.cc"
	"src/Ghidra/type.cc"
	"src/Ghidra/typegrp_ghidra.cc"
	"src/Ghidra/typeop.cc"
	"src/Ghidra/unify.cc"
	"src/Ghidra/unionresolve.cc"
	"src/Ghidra/userop.cc"
	"src/Ghidra/variable.cc"
	"src/Ghidra/varmap.cc"
	"src/Ghidra/varnode.cc"
	"src/Ghidra/xml.cc"
	"src/Ghidra/xml_arch.cc"
	"src/GhidraExtension/FuncBuildHelper.cpp"
	"src/GhidraExtension/IDALoadImage.cpp"
	"src/GhidraExtension/PrintManager.cpp"
	"src/GhidraExtension/VmpAction.cpp"
	"src/GhidraExtension/VmpArch.cpp"
	"src/GhidraExtension/VmpControlFlow.cpp"
	"src/GhidraExtension/VmpFunction.cpp"
	"src/GhidraExtension/VmpInstruction.cpp"
	"src/GhidraExtension/VmpInstructionAsm.cpp"
	"src/GhidraExtension/VmpInstructionBuilder.cpp"
	"src/GhidraExtension/VmpNode.cpp"
	"src/GhidraExtension/VmpRule.cpp"
	"src/Common/Public.cpp"
	"src/Common/StringUtils.cpp"
	"src/Common/VmpCommon.cpp"
	"src/Helper/AsmBuilder.cpp"
	"src/Helper/GhidraHelper.cpp"
	"src/Helper/IDAWrapper.cpp"
	"src/Helper/UnicornHelper.cpp"
	"src/Helper/VmpBlockAnalyzer.cpp"
	"src/Manager/DisasmManager.cpp"
	"src/Manager/SectionManager.cpp"
	"src/Manager/VmpVersionManager.cpp"
	"src/Manager/exceptions.cpp"
	"src/VmpCore/VmpBlockBuilder.cpp"
	"src/VmpCore/VmpReEngine.cpp"
	"src/VmpCore/VmpTraceFlowGraph.cpp"
	"src/VmpCore/VmpUnicorn.cpp"
	"src/IDAPlugin.h"
	"src/Ghidra/types.h"
	"src/Ghidra/action.hh"
	"src/Ghidra/address.hh"
	"src/Ghidra/architecture.hh"
	"src/Ghidra/block.hh"
	"src/Ghidra/blockaction.hh"
	"src/Ghidra/callgraph.hh"
	"src/Ghidra/capability.hh"
	"src/Ghidra/cast.hh"
	"src/Ghidra/comment.hh"
	"src/Ghidra/comment_ghidra.hh"
	"src/Ghidra/condexe.hh"
	"src/Ghidra/context.hh"
	"src/Ghidra/coreaction.hh"
	"src/Ghidra/cover.hh"
	"src/Ghidra/cpool.hh"
	"src/Ghidra/cpool_ghidra.hh"
	"src/Ghidra/crc32.hh"
	"src/Ghidra/database.hh"
	"src/Ghidra/database_ghidra.hh"
	"src/Ghidra/doccore.hh"
	"src/Ghidra/docmain.hh"
	"src/Ghidra/double.hh"
	"src/Ghidra/dynamic.hh"
	"src/Ghidra/emulate.hh"
	"src/Ghidra/emulateutil.hh"
	"src/Ghidra/error.hh"
	"src/Ghidra/filemanage.hh"
	"src/Ghidra/float.hh"
	"src/Ghidra/flow.hh"
	"src/Ghidra/fspec.hh"
	"src/Ghidra/funcdata.hh"
	"src/Ghidra/ghidra_arch.hh"
	"src/Ghidra/ghidra_context.hh"
	"src/Ghidra/ghidra_translate.hh"
	"src/Ghidra/globalcontext.hh"
	"src/Ghidra/grammar.hh"
	"src/Ghidra/graph.hh"
	"src/Ghidra/heritage.hh"
	"src/Ghidra/inject_ghidra.hh"
	"src/Ghidra/inject_sleigh.hh"
	"src/Ghidra/interface.hh"
	"src/Ghidra/jumptable.hh"
	"src/Ghidra/libdecomp.hh"
	"src/Ghidra/loadimage.hh"
	"src/Ghidra/loadimage_ghidra.hh"
	"src/Ghidra/loadimage_xml.hh"
	"src/Ghidra/marshal.hh"
	"src/Ghidra/memstate.hh"
	"src/Ghidra/merge.hh"
	"src/Ghidra/modelrules.hh"
	"src/Ghidra/op.hh"
	"src/Ghidra/opbehavior.hh"
	"src/Ghidra/opcodes.hh"
	"src/Ghidra/options.hh"
	"src/Ghidra/override.hh"
	"src/Ghidra/paramid.hh"
	"src/Ghidra/partmap.hh"
	"src/Ghidra/pcodecompile.hh"
	"src/Ghidra/pcodeinject.hh"
	"src/Ghidra/pcodeparse.hh"
	"src/Ghidra/pcoderaw.hh"
	"src/Ghidra/prefersplit.hh"
	"src/Ghidra/prettyprint.hh"
	"src/Ghidra/printc.hh"
	"src/Ghidra/printjava.hh"
	"src/Ghidra/printlanguage.hh"
	"src/Ghidra/rangemap.hh"
	"src/Ghidra/rangeutil.hh"
	"src/Ghidra/raw_arch.hh"
	"src/Ghidra/ruleaction.hh"
	"src/Ghidra/rulecompile.hh"
	"src/Ghidra/semantics.hh"
	"src/Ghidra/signature.hh"
	"src/Ghidra/sleigh.hh"
	"src/Ghidra/sleigh_arch.hh"
	"src/Ghidra/sleighbase.hh"
	"src/Ghidra/slghpatexpress.hh"
	"src/Ghidra/slghpattern.hh"
	"src/Ghidra/slghsymbol.hh"
	"src/Ghidra/space.hh"
	"src/Ghidra/string_ghidra.hh"
	"src/Ghidra/stringmanage.hh"
	"src/Ghidra/subflow.hh"
	"src/Ghidra/transform.hh"
	"src/Ghidra/translate.hh"
	"src/Ghidra/type.hh"
	"src/Ghidra/typegrp_ghidra.hh"
	"src/Ghidra/typeop.hh"
	"src/Ghidra/unify.hh"
	"src/Ghidra/unionresolve.hh"
	"src/Ghidra/userop.hh"
	"src/Ghidra/variable.hh"
	"src/Ghidra/varmap.hh"
	"src/Ghidra/varnode.hh"
	"src/Ghidra/xml.hh"
	"src/Ghidra/xml_arch.hh"
	"src/GhidraExtension/FuncBuildHelper.h"
	"src/GhidraExtension/IDALoadImage.h"
	"src/GhidraExtension/PrintManager.h"
	"src/GhidraExtension/VmpAction.h"
	"src/GhidraExtension/VmpArch.h"
	"src/GhidraExtension/VmpControlFlow.h"
	"src/GhidraExtension/VmpFunction.h"
	"src/GhidraExtension/VmpInstruction.h"
	"src/GhidraExtension/VmpNode.h"
	"src/GhidraExtension/VmpRule.h"
	"src/Common/Public.h"
	"src/Common/StringUtils.h"
	"src/Common/VmpCommon.h"
	"src/Helper/AsmBuilder.h"
	"src/Helper/GhidraHelper.h"
	"src/Helper/IDAWrapper.h"
	"src/Helper/UnicornHelper.h"
	"src/Helper/VmpBlockAnalyzer.h"
	"src/Manager/DisasmManager.h"
	"src/Manager/SectionManager.h"
	"src/Manager/VmpVersionManager.h"
	"src/Manager/exceptions.h"
	"src/VmpCore/VmpBlockBuilder.h"
	"src/VmpCore/VmpReEngine.h"
	"src/VmpCore/VmpTraceFlowGraph.h"
	"src/VmpCore/VmpUnicorn.h"
	cmake.toml
)

add_library(Revampire SHARED)

target_sources(Revampire PRIVATE ${Revampire_SOURCES})
source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${Revampire_SOURCES})

target_compile_definitions(Revampire PUBLIC
	_WINDOWS
	_CRT_SECURE_NO_WARNINGS
	USE_STANDARD_FILE_FUNCTIONS
)

target_include_directories(Revampire PUBLIC
	"${CMAKE_BINARY_DIR}/vcpkg_installed/${VCPKG_TARGET_TRIPLET}/include"
	"IDA83_SDK/include"
	include
)

target_link_directories(Revampire PUBLIC
	"${CMAKE_BINARY_DIR}/vcpkg_installed/${VCPKG_TARGET_TRIPLET}/lib"
	"IDA83_SDK/lib/x64_win_vc_32_pro"
)

target_link_libraries(Revampire PUBLIC
	capstone::capstone
	keystone
	unicorn
	libz3
	ida
)

set(CMKR_TARGET Revampire)
set_property(TARGET Revampire PROPERTY
  MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
